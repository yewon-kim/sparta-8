<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Server Practice</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css" />
  <style>
    .make-center {
      text-align: center;
    }

    .posting-box {
      width: 500px;
      margin: 10px auto 0 auto;
      display: flex;
      flex-direction: column;
    }

    #posting-comment {
      padding: 8px;
    }

    .star-list {
      width: 500px;
      margin: 20px auto 0 auto;
    }

    .star-name {
      display: inline-block;
    }

    .star-name:hover {
      color: gray;
    }

    .card {
      margin-bottom: 15px;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <script type="text/javascript" src="http://jsgetip.appspot.com"></script>

  <script>
    $(document).ready(function () {
      // index.html 로드가 완료되면 자동으로 show_star() 함수를 호출합니다.
      show_star_like();
    });

    function fn_dateTimeToFormatted(dt) {
      var min = 60 * 1000;
      var c = new Date()
      var d = new Date(dt * 1000);
      var minsAgo = Math.floor((c - d) / (min));

      var result = {
        'raw': d.getFullYear() + '-' + (d.getMonth() + 1 > 9 ? '' : '0') + (d.getMonth() + 1) + '-' + (d.getDate() > 9 ? '' : '0') + d.getDate() + ' ' + (d.getHours() > 9 ? '' : '0') + d.getHours() + ':' + (d.getMinutes() > 9 ? '' : '0') + d.getMinutes() + ':' + (d.getSeconds() > 9 ? '' : '0') + d.getSeconds(),
        'formatted': '',
      };

      if (minsAgo < 60) { // 1시간 내
        result.formatted = minsAgo + '분 전';
      } else if (minsAgo < 60 * 24) { // 하루 내
        result.formatted = Math.floor(minsAgo / 60) + '시간 전';
      } else if (minsAgo < 60 * 24 * 30) { // 하루 이상
        result.formatted = Math.floor(minsAgo / 60 / 24) + '일 전';
      } else if (minsAgo < 60 * 24 * 365) { // 1달 이상
        result.formatted = Math.floor(minsAgo / 60 / 24 / 30) + '달 전';
      } else { // 1년 이상
        result.formatted = Math.floor(minsAgo / 60 / 24 / 365) + '년 전';
      };

      return result.formatted;
    };

    function make_card(img_url, url, name, comment, nation, time, objectid, like) {
      let temp_html = `<div class="card">
                                      <div class="card-content">
                                        <div class="media">
                                          <div class="media-left">
                                            <figure class="image is-48x48">
                                              <img
                                                src="${img_url}"
                                                alt="Placeholder image"
                                              />
                                            </figure>
                                          </div>
                                          <div class="media-content">
                                            <a href="${url}" target="_blank" class="star-name title is-4">${name}</a>
                                            <p class="subtitle is-6">${comment}</p>
                                            <a href="#" class="subtitle is-6">${nation}</a>
                                            <p class="subtitle is-6">${time}</p>
                                          </div>
                                        </div>
                                      </div>
                                      <footer class="card-footer">
                                        <a href="#" onclick="like_star('${objectid}')" class="card-footer-item has-text-info" id="likeStar">
                                          좋아요 ${like}
                                        </a>
                                        <a href="#" onclick="delete_star('${objectid}')" class="card-footer-item has-text-danger">
                                          삭제
                                          <span class="icon">
                                            <i class="fas fa-ban"></i>
                                          </span>
                                        </a>
                                      </footer>
                                    </div>`
      return temp_html;
    }
    

    function show_star_like() {
      // 1. #star_box의 내부 html 태그를 모두 삭제합니다.
      $('#star-box').empty()

      // 2. 서버에 1) GET 방식으로, 2) /api/list 라는 주소로 star_list를 요청합니다.
      $.ajax({
        type: "GET",
        url: "/api/list",
        data: {},
        success: function (response) {
          // 3. 서버가 돌려준 star_list를 star라는 변수에 저장합니다.
          let stars = response['stars_list']
          // 4. for 문을 활용하여 star 배열의 요소를 차례대로 조회합니다.
          for (let i = 0; i < stars.length; i++) {
            let star = stars[i];

            let objectid = star['_id']
            let nation = star['nation']
            let time_unix = star['time']
            let time = fn_dateTimeToFormatted(time_unix)
            let name = star['name']
            let url = star['url']
            let img_url = star['img_url']
            let comment = star['comment']
            let like = star['like']

            // 6. 카드를 만듭니다.
            card = make_card(img_url, url, name, comment, nation, time, objectid, like);

            // 7. #star-box에 temp_html을 붙입니다.
            $('#star-box').append(card)
          }
        }
      });
    }

    function show_star_new() {
      // 1. #star_box의 내부 html 태그를 모두 삭제합니다.
      $('#star-box').empty()

      // 2. 서버에 1) GET 방식으로, 2) /api/list 라는 주소로 star_list를 요청합니다.
      $.ajax({
        type: "GET",
        url: "/api/new",
        data: {},
        success: function (response) {
          // 3. 서버가 돌려준 star_list를 star라는 변수에 저장합니다.
          let stars = response['stars_list']
          // 4. for 문을 활용하여 star 배열의 요소를 차례대로 조회합니다.
          for (let i = 0; i < stars.length; i++) {
            let star = stars[i];

            let objectid = star['_id']
            let nation = star['nation']
            let time_unix = star['time']
            let time = fn_dateTimeToFormatted(time_unix)
            let name = star['name']
            let url = star['url']
            let img_url = star['img_url']
            let comment = star['comment']
            let like = star['like']

            // 6. 카드를 만듭니다.
            card = make_card(img_url, url, name, comment, nation, time, objectid, like);

            // 7. #star-box에 temp_html을 붙입니다.
            $('#star-box').append(card)
          }
        }
      });
    }

    function show_star_kr() {
      // 1. #star_box의 내부 html 태그를 모두 삭제합니다.
      $('#star-box').empty()

      // 2. 서버에 1) GET 방식으로, 2) /api/list 라는 주소로 star_list를 요청합니다.
      $.ajax({
        type: "GET",
        url: "/api/kr",
        data: {},
        success: function (response) {
          // 3. 서버가 돌려준 star_list를 star라는 변수에 저장합니다.
          let stars = response['stars_list']
          // 4. for 문을 활용하여 star 배열의 요소를 차례대로 조회합니다.
          for (let i = 0; i < stars.length; i++) {
            let star = stars[i];

            let objectid = star['_id']
            let nation = star['nation']
            let time_unix = star['time']
            let time = fn_dateTimeToFormatted(time_unix)
            let name = star['name']
            let url = star['url']
            let img_url = star['img_url']
            let comment = star['comment']
            let like = star['like']

            // 6. 카드를 만듭니다.
            card = make_card(img_url, url, name, comment, nation, time, objectid, like);

            // 7. #star-box에 temp_html을 붙입니다.
            $('#star-box').append(card)
          }
        }
      });
    }

    function posting() {
      let comment = $('#posting-comment').val();
      let nation = $('#nation').val();

      $.ajax({
        type: "POST",
        url: "/api/add",
        data: {
          'comment_give': comment, 
          'nation_give': nation
        },
        success: function (response) {
          if (response['result'] == 'success') {
            alert(response['msg']);
            window.location.reload()
          }
        }
      })
    }

    function like_star(objectid) {
      $.ajax({
        type: "POST",
        url: "/api/like",
        data: { 'objectid_give': objectid },
        success: function (response) {
          if (response['result'] == 'success') {
            alert('좋아요 완료!')
            window.location.reload()
          }
        }
      });
    }

    function delete_star(objectid) {
      $.ajax({
        type: "POST",
        url: "/api/delete",
        data: { 'objectid_give': objectid },
        success: function (response) {
          if (response['result'] == 'success') {
            alert('삭제 완료!')
            window.location.reload()
          }
        }
      });
    }

  </script>
</head>

<body>
  <section class="hero is-warning">
    <div class="hero-body">
      <div class="container make-center">
        <h1 class="title">
          Example Title
        </h1>
        <h2 class="subtitle">
          Example subtitle
        </h2>
      </div>
    </div>
  </section>

  <button onclick="show_star_like()">추천순</button>
  <button onclick="show_star_new()">최신순</button>
  <button onclick="show_star_kr()">한국 관련 뉴스</button>

  <div class="posting-box">
    <!-- <input type="text" placeholder="Enter url" id="posting-url"> -->
    <select name='nation' id="nation">
      <option value='World' selected>World</option>
      <option value='United States'>United States</option>
      <option value='South Korea'>South Korea</option>
    </select>
    <textarea rows="5" placeholder="Enter comment" id="posting-comment"></textarea>
    <button onclick="posting()">저장</button>
  </div>

  <div class="star-list" id="star-box">
    <div class="card">
      <div class="card-content">
        <div class="media">
          <div class="media-left">
            <figure class="image is-48x48">
              <img
                src="https://search.pstatic.net/common/?src=https%3A%2F%2Fssl.pstatic.net%2Fsstatic%2Fpeople%2Fportrait%2F201807%2F20180731143610623-6213324.jpg&type=u120_150&quality=95"
                alt="Placeholder image" />
            </figure>
          </div>
          <div class="media-content">
            <a href="https://movie.naver.com//movie/bi/pi/basic.nhn?st=1&code=397373" target="_blank"
              class="star-name title is-4">김다미 (좋아요: 3)</a>
            <p class="subtitle is-6">안녕, 나의 소울메이트(가제)</p>
          </div>
        </div>
      </div>
      <footer class="card-footer">
        <a href="#" onclick="like_star('김다미')" class="card-footer-item has-text-info">
          위로!
          <span class="icon">
            <i class="fas fa-thumbs-up"></i>
          </span>
        </a>
        <a href="#" onclick="delete_star('김다미')" class="card-footer-item has-text-danger">
          삭제
          <span class="icon">
            <i class="fas fa-ban"></i>
          </span>
        </a>
      </footer>
    </div>
  </div>
</body>

</html>